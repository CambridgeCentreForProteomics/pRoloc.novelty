---
title: "Bayesian spatial proteomics with pRoloc"
author:
- name: Oliver Crook
- name: Laurent Gatto
package: pRoloc
output:
  BiocStyle::html_document:
   toc_float: true
vignette: >
  %\VignetteIndexEntry{Bayesian spatial proteomics with pRoloc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

```{r env, echo=FALSE, message=FALSE}
library("pRoloc")
library("pRolocdata")
```

# Introduction

For an in-depth description of the infrastructure for Bayesian spatial
proteomics, please see

> A Bayesian Mixture Modelling Approach For Spatial Proteomics Oliver
> M Crook, Claire M Mulvey, Paul D. W. Kirk, Kathryn S Lilley, Laurent
> Gatto bioRxiv 282269; doi: https://doi.org/10.1101/282269

Analysis of the spatial sub-cellular distribution of proteins is of
vital importance to fully understand context specific protein
function. Some proteins can be found with a single location within a
cell, but up to half of proteins may reside in multiple locations, can
dynamically relocalise, or reside within an unknown functional
compartment. These considerations lead to uncertainty in associating a
protein to a single location. Currently, mass spectrometry (MS) based
spatial proteomics relies on supervised machine learning algorithms to
assign proteins to sub-cellular locations based on common gradient
profiles. However, such methods fail to quantify uncertainty
associated with sub-cellular class assignment. Here we reformulate the
framework on which we perform statistical analysis. We propose a
Bayesian generative classifier based on Gaussian mixture models to
assign proteins probabilistically to sub-cellular niches, thus
proteins have a probability distribution over sub-cellular locations,
with Bayesian computation performed using the expectation-maximisation
(EM) algorithm (coined TAGM-MAP, for *maximum a posteriori*), as well
as Markov-chain Monte-Carlo (coined TAGM-MCMC). Our methodology allows
proteome-wide uncertainty quantification, thus adding a further layer
to the analysis of spatial proteomics. Our framework is flexible,
allowing many different systems to be analysed and reveals new
modelling opportunities for spatial proteomics. We find our methods
perform competitively with current state-of-the art machine learning
methods, whilst simultaneously providing more information. We
highlight several examples where classification based on the support
vector machine is unable to make any conclusions, while uncertainty
quantification using our approach provides biologically intriguing
results.  To our knowledge this is the first Bayesian model of
MS-based spatial proteomics data.


# The *TAGM-MAP* method

We will use a subsest of the `tan2009r1` dataset from the
`Biocexptpkg("pRolocdata")` to illustrate the TAGM-MAP method

```{r tan}
library("pRolocdata")
data(tan2009r1)
set.seed(1)
tan2009r1 <- tan2009r1[sample(nrow(tan2009r1), 400), ]
```

The first step is to generate the model parameters using the
`tagmMapTrain` function, that will generate an instance of class
`MAPParams`.

```{r tagmMapTrain}
library("pRoloc")
p <- tagmMapTrain(tan2009r1)
p
```

The results of the modelling can be visualised with the `plotEllipse`
function. The outer ellipse contains 99% of the total probability
whilst the middle and inner ellipses contain 95% and 90% of the
probability respectively. The centres of the clusters are represented
by black circumpunct (circled dot).

```{r plotEllipse}
plotEllipse(tan2009r1, p)
```

The `MAPParams` object can now be used to classify the proteins of
unknown localisation using `tagmPredict`.


```{r tagmPredict}
res <- tagmPredict(tan2009r1, p)
```

The new feature variables that are generated are:

- `tagm.map.allocation`: the TAGM-MAP predictions for the most likely
  protein sub-cellular allocation.

```{r alloc}
table(fData(res)$tagm.map.allocation)
```

- `tagm.map.probability`: the posterior probability for the protein
  sub-cellular allocations.

```{r prob}
summary(fData(res)$tagm.map.probability)
```

- `tagm.map.outlier`: the probability for that protein to belong
  to the outlier component rather than any annotated component.

```{r oultlier}
summary(fData(res)$tagm.map.outlier)
```

# The *TAGM-MCMC* method

We will use a subsest of the `tan2009r1` dataset from the
`Biocexptpkg("pRolocdata")` to illustrate the TAGM-MCMC method

The first step is run two MCMC chains for a few iterations of the algorithm
using the `tagmMcmcTrain` function.
This function will generate a object of class `MCMCParams`. The summary
slot of which is currently empty.

```{r tagmMcmcTrain}
library("pRoloc")
p <- tagmMcmcTrain(object = tan2009r1, numIter = 3,
                   burnin = 1, thin = 1, numChains = 2)
p
```
 Information for each MCMC chain is contained within the chains slot. This
 information can be accessed manually if need. The function `MCMCProcess`
 populates the summary slot of the `MCMCParams` object
  
```{r tagmMCMCProcess}
p <- tagmMcmcProcess(p)
head(p@summary@posteriorEstimates)

```
The summary slot has now been populated to include basic summaries of the `MCMCChains`,
such as allocations and localisation probabilities. Protein information can be appended
to the feature columns of the `MSnSet` by using the `tagmPredict` function, which extracts the required information
from the summary slot of the `MCMCParams` object.

```{r tagmPredict mcmc}
res <- tagmPredict(object = tan2009r1, params = p)
```
One can access new features variables:

- `tagm.mcmc.allocation`: the TAGM-MCMC prediction for the most likely
  protein sub-cellular annotation.
```{r}
table(fData(res)$tagm.mcmc.allocation)
```
- `tagm.mcmc.probability`: the posterior probability for the protein
  sub-cellular allocations.
```{r}
summary(fData(res)$tagm.mcmc.probability)
```
As well as other useful summaries of the MCMC methods:

- `tagm.mcmc.outlier` the posterior probability for the protein
  to belong to the outlier component.
  
- `tagm.mcmc.probability.lowerquantile` and  `tagm.mcmc.probability.upperquantile`
 are the lower and upper boundaries to the equi-tailed 95% credible interval
 of `tagm.mcmc.probability`.
 
-  `tagm.mcmc.mean.shannon` a Monte-Carlo averaged shannon entropy, which is a measure 
of uncertainty in the allocations.

# Session information {-}

```{r si}
sessionInfo()
```
